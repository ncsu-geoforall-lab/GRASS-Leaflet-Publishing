<!DOCTYPE html>
<!--
Copyright (C) 2013 Vaclav Petras

This program is free software under the GNU General Public
License (>=v2). See the file LICENSE for details.
-->
<html>
<head>
    <title>Leaflet Jockey's Ridge elevation</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="description" content=""/>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
        }
        /*
        #map {
            width:50%; float:left;
        }
        */
        .overlay {
			position:absolute; 
			padding: 6px 8px;
			font: 14px/16px Tahoma,Verdana,sans-serif;
			color: #223;
			background-color: rgba(255,255,255,0.8);
			border-radius: 5px;
		}
		.box {

			bottom:10%;
			left:0.5%;
			right:79%;
				/*	width:50%; float:right*/
		}
		.box img {
		    width: 90%;
		    max-height: 20%;
		}
    </style>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

    <link rel="stylesheet" href="libs/leaflet/leaflet.css" />
    <!--[if lte IE 8]><link rel="stylesheet" href="libs/leaflet/leaflet.ie.css" /><![endif]-->
</head>
<body>

    <div id="map"></div>
    <div id="additional-info"class="overlay box"></div>

    <script src="libs/leaflet/leaflet.js"></script>
    <script src="data/data_file.js"></script>
    <script>

        // string: http://www.w3schools.com/jsref/jsref_obj_string.asp
        // array: http://www.w3schools.com/js/js_obj_array.asp
        // log to browser console:
        // http://stackoverflow.com/questions/4539253/what-is-console-log
        // http://getfirebug.com/logging
        // https://developers.google.com/chrome-developer-tools/docs/console

        // create OpenStreetMap layer
        var osmLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            minZoom: 1,
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">CC BY-SA</a>'
        });

        // create MapQuest layer
        var mapquestUrl = 'http://oatile{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png';
        var subDomains = '1234';
        var mapquestAttrib = 'Imagery &copy; <a href="http://open.mapquest.co.uk" target="_blank">MapQuest</a>';
        var mapquest = new L.TileLayer(mapquestUrl, {maxZoom: 18, attribution: mapquestAttrib, subdomains: subDomains});

        // create list of all base layers
        var baseLayersList = {
            "Open Street Map": osmLayer,
            "MapQuest imagery": mapquest
        };

        // create image overlay layers
        var imageLayers = new Array();
        var imageLayersTitles = new Array();
        // create list of all overlay layers as a dictionary for
        // layer controler
        var overlayLayersList = new Array();

        var overlayInfos = new Array();

        for(var i = 0; i < layerInfos.length; i += 1) {
            layerInfo = layerInfos[i];
            console.log(layerInfo);
            var overlay = L.imageOverlay('data/' + layerInfo.file, layerInfo.bounds, {opacity: layerInfo.opacity});
            imageLayers.push(overlay);
            overlayLayersList[layerInfo.title] = overlay
            imageLayersTitles.push(layerInfo.title);

            overlayInfos[layerInfo.title] = layerInfo
        }

        // derive center from the first image bounds
        var firstImageBounds = layerInfos[0].bounds
        // compute approximate center of the image
        var imageCenter = [(firstImageBounds[0][0] + firstImageBounds[1][0]) / 2,
                           (firstImageBounds[0][1] + firstImageBounds[1][1]) / 2];

        // create map object
        // setting default map position and zoom
        // adding only layers which should be visible at the beginning
        var map = L.map('map', {
            center: imageCenter,
            zoom: 15,
            layers: [osmLayer, imageLayers[0]]
        });

        // create layer control
        // first parameter are base layers
        // we don't have any, so putting there null
        // (null is accepted by L.control.layers)
        var layerControl = L.control.layers(baseLayersList, overlayLayersList);

        // add layer control to the map object
        layerControl.addTo(map)

        var currentImageLayerIndex = 0;
        var maxImageLayerIndex = imageLayers.length - 1;
        console.log("max %d", maxImageLayerIndex)

        function onOverlayAdd(layer) {
            console.log(layer.name)
            layerInfo = overlayInfos[layer.name]
            overlay = overlayLayersList[layer.name]
            currentOpacity = overlay.options.opacity * 100
            console.log("overlay opacity: " + currentOpacity)
            $('#additional-info').html('<h6>' + layerInfo.title + '</h6><div id="opacity-slider" style="width: 70%; margin: 10px; float: left;"></div><div id="opacity-number">' + currentOpacity + '</div><img alt="preview" src="data/' + layerInfo.file + '">')

            // thumbnail
            // histogram
            // statistics
            // r.info?
            // 3d image
            // description
            // some command output?

        // added recently, no user info
        $(function() {
            console.log('slider')
            $( "#opacity-slider" ).slider({
                value: currentOpacity,
                min: 0,
                max: 100,
                step: 1,
                slide: function (e, ui) {
                    console.log('opacity '+ ui.value+ layer)
                    value = ui.value / 100.0;
                    overlay.setOpacity(value)
                    $( "#opacity-number" ).html(ui.value)
                }
            });
        });
            
        }

        // zoom to layer

        map.on('overlayadd', onOverlayAdd, {autoZIndex: true})

        L.control.scale().addTo(map);
        map.attributionControl.addAttribution('Overlay data &copy; by <a href="http://gis.ncsu.edu/osgeorel/" target="_blank">NCSU OSGeoREL</a>')

    </script>
</body>
</html>

